<!doctype html><html lang='en'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<meta name='description' content='API documentation for BPlusTree.Lock| The Flix Programming Language'>
<meta name='keywords' content='Flix, Programming, Language, API, Documentation, BPlusTree.Lock'>
<base href='BPlusTree.Lock.html'>
<link href='https://fonts.googleapis.com/css?family=Fira+Code&display=swap' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Oswald&display=swap' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Noto+Sans&display=swap' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Inter&display=swap' rel='stylesheet'>
<link href='styles.css' rel='stylesheet'>
<link href='favicon.png' rel='icon'>
<script type='module' src='index.js'></script>
<title>Flix | BPlusTree.Lock</title>
</head>
    <body class='no-script'><header><div class='flix'><h2><a href='index.html'>flix</a></h2><span class='version'>0.67.2</span></div><div class='spacer' role='presentation'></div><button id='theme-toggle' class='toggle' aria-label='Toggle Theme'><span class='dark icon'><!-- Google Material Symbols - "Dark Mode" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Dark Mode Icon"><path d="M480.24-140.41q-142.63 0-241.23-98.48t-98.6-241.14q0-123.9 78.74-218.9t205.41-115.65q14.29-3.33 25.94 1.95 11.65 5.28 18.52 14.52 6.87 9.24 8.61 22.2 1.74 12.95-3.83 26.11-10.89 22.04-17.31 46.15-6.42 24.11-6.42 48 0 86.69 59.82 146.38 59.83 59.68 146.72 59.68 24.32 0 48.46-5.94 24.13-5.95 45.93-17.08 12.91-5.8 25.13-3.61 12.22 2.2 20.63 8.63 9.35 6.44 14.63 17.73 5.28 11.3 2.09 25.45Q795.17-300 700.63-220.21q-94.54 79.8-220.39 79.8Zm-1-83q76.7 0 138.72-41.23 62.02-41.22 92.41-108.27-17.61 4.04-34.1 6.32-16.49 2.29-32.86 1.81-113.31-4.07-193.08-83.35-79.76-79.28-84.31-194.68-.24-15.97 1.93-32.58 2.16-16.61 6.44-33.98-66.82 30.48-108.28 92.58-41.46 62.11-41.46 138.53 0 106.19 74.56 180.52 74.56 74.33 180.03 74.33Zm-11.11-243.48Z"/></svg>
</span><span class='light icon'><!-- Google Material Symbols - "Light Mode" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Light Mode Icon"><path d="M480-371q45.46 0 77.23-31.77Q589-434.54 589-480q0-45.46-31.77-77.23Q525.46-589 480-589q-45.46 0-77.23 31.77Q371-525.46 371-480q0 45.46 31.77 77.23Q434.54-371 480-371Zm-.23 83Q400-288 344-344.23q-56-56.22-56-136Q288-560 344.23-616q56.22-56 136-56Q560-672 616-615.77q56 56.22 56 136Q672-400 615.77-344q-56.22 56-136 56ZM84-438.5q-17.45 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54Q66.55-521.5 84-521.5h96q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54Q197.45-438.5 180-438.5H84Zm696 0q-17.45 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54Q762.55-521.5 780-521.5h96q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54Q893.45-438.5 876-438.5h-96Zm-299.79-300q-17.36 0-29.54-12.02Q438.5-762.55 438.5-780v-96q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02Q521.5-893.45 521.5-876v96q0 17.45-11.96 29.48-11.97 12.02-29.33 12.02Zm0 696q-17.36 0-29.54-12.02Q438.5-66.55 438.5-84v-96q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02Q521.5-197.45 521.5-180v96q0 17.45-11.96 29.48-11.97 12.02-29.33 12.02ZM238.17-662.93l-50-51q-12.67-11.68-12.67-28.33t12.67-29.57q11.87-12.67 28.81-12.67 16.93 0 28.85 12.67l51.24 50q12.67 12.38 12.55 29.24-.12 16.86-12.55 29.48-11.68 12.61-28.95 12.85-17.27.24-29.95-12.67Zm476 474.76-51.24-50q-12.67-12.11-12.67-28.92 0-16.82 12.67-29.74 11.68-12.67 28.95-12.67t29.95 12.67l50 50.76q12.67 11.68 12.67 28.33t-12.2 29.57q-12.91 12.67-29.06 12.67t-29.07-12.67Zm-51.06-474.76q-12.61-11.68-12.61-28.95t12.67-29.95l50.76-50q12.68-12.67 28.83-12.17t29.07 12.22q12.67 12.39 12.67 28.54t-12.67 29.07l-50 51.24q-12.38 12.67-29.24 12.55-16.86-.12-29.48-12.55ZM188.17-188.17q-12.67-11.87-12.67-28.81 0-16.93 12.67-28.85l50-51.24q12.11-11.67 28.92-11.67 16.82 0 29.74 11.67 12.67 12.68 12.21 29.62-.46 16.94-12.21 29.28l-50.76 50q-11.68 12.67-28.33 12.67t-29.57-12.67ZM480-480Z"/></svg>
</span></button><div id='menu-toggle' class='toggle'><input type='checkbox' aria-label='Toggle Navigation Menu'><span class='open icon'><!-- Google Material Symbols - "Menu" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Menu Icon"><path d="M177.37-252.28q-17.45 0-29.48-11.97-12.02-11.96-12.02-29.32t12.02-29.54q12.03-12.17 29.48-12.17h605.26q17.45 0 29.48 11.96 12.02 11.96 12.02 29.33 0 17.36-12.02 29.53-12.03 12.18-29.48 12.18H177.37Zm0-186.22q-17.45 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.03-12.17 29.48-12.17h605.26q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H177.37Zm0-186.22q-17.45 0-29.48-11.96-12.02-11.96-12.02-29.33 0-17.36 12.02-29.53 12.03-12.18 29.48-12.18h605.26q17.45 0 29.48 11.97 12.02 11.96 12.02 29.32t-12.02 29.54q-12.03 12.17-29.48 12.17H177.37Z"/></svg>
</span><span class='close icon'><!-- Google Material Symbols - "Close" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Close Icon"><path d="M480-421.35 319.83-261.17Q307.15-248.5 291-249t-28.83-13.17q-12.67-12.68-12.67-29.33t12.67-29.33L421.35-480 261.17-640.17Q248.5-652.85 249-669.5t13.17-29.33q12.68-12.67 29.33-12.67t29.33 12.67L480-538.65l160.17-160.18q12.68-12.67 29.33-12.67t29.33 12.67q12.67 12.68 12.67 29.33t-12.67 29.33L538.65-480l160.18 160.17Q711.5-307.15 711.5-291t-12.67 28.83q-12.68 12.67-29.33 12.67t-29.33-12.67L480-421.35Z"/></svg>
</span></div></header><nav><a class='back' href='BPlusTree.html'><!-- Google Material Symbols - "Back Arrow" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Back Icon"><path d="m343.15-438.5 166.89 166.89q12.46 12.46 12.58 29.35.12 16.89-12.55 30.04-12.68 12.2-29.57 12.08-16.89-.12-29.37-12.62L213.34-450.84q-6.12-6.13-9.22-13.64-3.1-7.51-3.1-15.68t3.1-15.68q3.1-7.51 8.81-13.23L451.17-747.3q12.92-12.92 29.74-12.92 16.81 0 29.16 12.92 12.67 12.34 12.67 29.27 0 16.94-12.52 29.46L343.15-521.5h391.51q17.44 0 29.45 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.01 12.17-29.45 12.17H343.15Z"/></svg>
BPlusTree</a><h3><a href='#Definitions'>Definitions</a></h3><ul class='Definitions'><li><a href='#def-isLocked'>isLocked</a></li><li><a href='#def-mkLock'>mkLock</a></li><li><a href='#def-tryConvertToWrite'>tryConvertToWrite</a></li><li><a href='#def-tryReadLock'>tryReadLock</a></li><li><a href='#def-unlockWrite'>unlockWrite</a></li><li><a href='#def-valid'>valid</a></li><li><a href='#def-writeLock'>writeLock</a></li><li><a href='#def-yieldBasedOn'>yieldBasedOn</a></li></ul></nav><main><h1>BPlusTree.Lock</h1><div class='box' id='main-box'><div class='decl'><code><span class='keyword'>enum</span> <span class='name'>Lock</span><span class='tparams'>[<span class='tparam'><span class='type'>_</span>: <span class='kind'>Eff</span></span>]</span></code><span class='actions'><a class='source' target='_blank' rel='nofollow' href='https://github.com/flix/flix/blob/master/main/src/library/BPlusTree.flix#L87-L119#L87-L119'>Source</a></span></div><div class='cases'><code><span class='keyword'>case</span> <span class='case-tag'>Lock</span>(<span class='type'>java.util.concurrent.locks.StampedLock</span>)</code></div><div class='doc'><p>The purpose of Lock is to provide a thin wrapper around Java's StampedLock without
the IO effect. The lock is optimistic in the sense that reads are performed by
reading the values and only afterwards verifying that no other thread has changed
the values. Only annotating a region effect to StampedLock is safe, since it can
only non-deterministically block a thread for some ( potentially infinite) amount
of time. This is allowed under non-effectful behavior.</p>
<p>One possible danger, introduced by StampedLock, is handled by a null-check in
binarySearch. Consider the following example where everything is initialized to 0:
Thread 1 executes
{a = 2; b = 3}
Thread 2 executes
{c = a; d = b}
The question is what can <code>c</code> and <code>d</code> be? It depends on the JVM, but can be any of:
{c = 2, d = 3}, {c = 0, d = 0}, {c = 2, d = 0}, {c = 0, d = 3}
The last follows from the fact that the JVM can reorder statements under some
requirements. The requirements are roughly that the new 'code' should be
equivalent on a single-threaded machine and there are no happens-before relations
which link to other threads preventing the reordering. If either variable were
volatile we might avoid this, but volatile is expensive (and not in Flix).</p>
<p>For us, this means that {array[size] = 5; size++} can be reordered to
{oldSize = size++; array[oldSize] = 5}.
Another thread reading may then see the increase of size and try to access that
position getting null. This has not happened in our experiments, but we wish to
handle the case. The risk is in binarySearch and we therefore check whether any
value read is null and if so 'aborts'.</p>
<p>For Java's memory model see: https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.4</p>
</div></div><section id='Definitions'><h2>Definitions</h2><div class='box' id='def-isLocked'><div class='decl'><code><span class='keyword'>def</span> <span class='name'>isLocked</span><span class='fparams'>(<span><span>lock</span>: <span class='type'>Lock[r]</span></span>)</span>: <span class='type'>Bool</span> \ <span class='effect'>r</span></code><span class='actions'><a href='#def-isLocked' class='copy-link' title='Link To Element'><!-- Google Material Symbols - "Link" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Link Icon"><path d="M288-279.87q-83.05 0-141.59-58.6-58.54-58.6-58.54-141.74 0-83.14 58.54-141.53T288-680.13h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288q-48.8 0-82.97 34.16-34.16 34.17-34.16 82.97t34.16 82.97q34.17 34.16 82.97 34.16h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288Zm80.7-162.22q-16.1 0-27.15-10.84-11.05-10.84-11.05-26.86t10.89-27.07q10.89-11.05 26.98-11.05H591.3q16.1 0 27.15 10.84 11.05 10.84 11.05 26.86t-10.89 27.07q-10.89 11.05-26.98 11.05H368.7Zm204.39 162.22q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q48.8 0 82.97-34.16 34.16-34.17 34.16-82.97t-34.16-82.97Q720.8-597.13 672-597.13h-98.91q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q83.05 0 141.59 58.6 58.54 58.6 58.54 141.74 0 83.14-58.54 141.53T672-279.87h-98.91Z"/></svg>
</a> <a class='source' target='_blank' rel='nofollow' href='https://github.com/flix/flix/blob/master/main/src/library/BPlusTree%5CLock.flix#L44-L51#L44-L51'>Source</a></span></div><div class='doc'><p>Returns <code>true</code> if <code>lock</code> is currently held by a thread.</p>
<p>Only supposed to be used for testing.</p>
</div></div><div class='box' id='def-mkLock'><div class='decl'><code><span class='keyword'>def</span> <span class='name'>mkLock</span><span class='fparams'>(<span><span>_</span>: <span class='type'>Region[r]</span></span>)</span>: <span class='type'>Lock[r]</span> \ <span class='effect'>r</span></code><span class='actions'><a href='#def-mkLock' class='copy-link' title='Link To Element'><!-- Google Material Symbols - "Link" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Link Icon"><path d="M288-279.87q-83.05 0-141.59-58.6-58.54-58.6-58.54-141.74 0-83.14 58.54-141.53T288-680.13h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288q-48.8 0-82.97 34.16-34.16 34.17-34.16 82.97t34.16 82.97q34.17 34.16 82.97 34.16h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288Zm80.7-162.22q-16.1 0-27.15-10.84-11.05-10.84-11.05-26.86t10.89-27.07q10.89-11.05 26.98-11.05H591.3q16.1 0 27.15 10.84 11.05 10.84 11.05 26.86t-10.89 27.07q-10.89 11.05-26.98 11.05H368.7Zm204.39 162.22q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q48.8 0 82.97-34.16 34.16-34.17 34.16-82.97t-34.16-82.97Q720.8-597.13 672-597.13h-98.91q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q83.05 0 141.59 58.6 58.54 58.6 58.54 141.74 0 83.14-58.54 141.53T672-279.87h-98.91Z"/></svg>
</a> <a class='source' target='_blank' rel='nofollow' href='https://github.com/flix/flix/blob/master/main/src/library/BPlusTree%5CLock.flix#L53-L57#L53-L57'>Source</a></span></div><div class='doc'><p>Returns a fresh lock.</p>
</div></div><div class='box' id='def-tryConvertToWrite'><div class='decl'><code><span class='keyword'>def</span> <span class='name'>tryConvertToWrite</span><span class='fparams'>(<span><span>stamp</span>: <span class='type'>Int64</span></span>, <span><span>lock</span>: <span class='type'>Lock[r]</span></span>)</span>: <span class='type'>Int64</span> \ <span class='effect'>r</span></code><span class='actions'><a href='#def-tryConvertToWrite' class='copy-link' title='Link To Element'><!-- Google Material Symbols - "Link" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Link Icon"><path d="M288-279.87q-83.05 0-141.59-58.6-58.54-58.6-58.54-141.74 0-83.14 58.54-141.53T288-680.13h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288q-48.8 0-82.97 34.16-34.16 34.17-34.16 82.97t34.16 82.97q34.17 34.16 82.97 34.16h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288Zm80.7-162.22q-16.1 0-27.15-10.84-11.05-10.84-11.05-26.86t10.89-27.07q10.89-11.05 26.98-11.05H591.3q16.1 0 27.15 10.84 11.05 10.84 11.05 26.86t-10.89 27.07q-10.89 11.05-26.98 11.05H368.7Zm204.39 162.22q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q48.8 0 82.97-34.16 34.16-34.17 34.16-82.97t-34.16-82.97Q720.8-597.13 672-597.13h-98.91q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q83.05 0 141.59 58.6 58.54 58.6 58.54 141.74 0 83.14-58.54 141.53T672-279.87h-98.91Z"/></svg>
</a> <a class='source' target='_blank' rel='nofollow' href='https://github.com/flix/flix/blob/master/main/src/library/BPlusTree%5CLock.flix#L59-L66#L59-L66'>Source</a></span></div><div class='doc'><p>Attempt to upgrade <code>stamp</code> on <code>lock</code> to a write-lock on <code>lock</code>.
The returned stamp cannot be invalidated if it was valid when issued.</p>
<p>This operation is non-blocking.</p>
</div></div><div class='box' id='def-tryReadLock'><div class='decl'><code><span class='keyword'>def</span> <span class='name'>tryReadLock</span><span class='fparams'>(<span><span>lock</span>: <span class='type'>Lock[r]</span></span>)</span>: <span class='type'>Int64</span> \ <span class='effect'>r</span></code><span class='actions'><a href='#def-tryReadLock' class='copy-link' title='Link To Element'><!-- Google Material Symbols - "Link" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Link Icon"><path d="M288-279.87q-83.05 0-141.59-58.6-58.54-58.6-58.54-141.74 0-83.14 58.54-141.53T288-680.13h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288q-48.8 0-82.97 34.16-34.16 34.17-34.16 82.97t34.16 82.97q34.17 34.16 82.97 34.16h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288Zm80.7-162.22q-16.1 0-27.15-10.84-11.05-10.84-11.05-26.86t10.89-27.07q10.89-11.05 26.98-11.05H591.3q16.1 0 27.15 10.84 11.05 10.84 11.05 26.86t-10.89 27.07q-10.89 11.05-26.98 11.05H368.7Zm204.39 162.22q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q48.8 0 82.97-34.16 34.16-34.17 34.16-82.97t-34.16-82.97Q720.8-597.13 672-597.13h-98.91q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q83.05 0 141.59 58.6 58.54 58.6 58.54 141.74 0 83.14-58.54 141.53T672-279.87h-98.91Z"/></svg>
</a> <a class='source' target='_blank' rel='nofollow' href='https://github.com/flix/flix/blob/master/main/src/library/BPlusTree%5CLock.flix#L68-L76#L68-L76'>Source</a></span></div><div class='doc'><p>Return an optimistic stamp on <code>lock</code> which can be used in <code>valid</code> to
assert that no thread has taken a write lock since <code>stamp</code> was issued.</p>
<p>This operation is non-blocking.</p>
</div></div><div class='box' id='def-unlockWrite'><div class='decl'><code><span class='keyword'>def</span> <span class='name'>unlockWrite</span><span class='fparams'>(<span><span>stamp</span>: <span class='type'>Int64</span></span>, <span><span>lock</span>: <span class='type'>Lock[r]</span></span>)</span>: <span class='type'>Unit</span> \ <span class='effect'>r</span></code><span class='actions'><a href='#def-unlockWrite' class='copy-link' title='Link To Element'><!-- Google Material Symbols - "Link" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Link Icon"><path d="M288-279.87q-83.05 0-141.59-58.6-58.54-58.6-58.54-141.74 0-83.14 58.54-141.53T288-680.13h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288q-48.8 0-82.97 34.16-34.16 34.17-34.16 82.97t34.16 82.97q34.17 34.16 82.97 34.16h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288Zm80.7-162.22q-16.1 0-27.15-10.84-11.05-10.84-11.05-26.86t10.89-27.07q10.89-11.05 26.98-11.05H591.3q16.1 0 27.15 10.84 11.05 10.84 11.05 26.86t-10.89 27.07q-10.89 11.05-26.98 11.05H368.7Zm204.39 162.22q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q48.8 0 82.97-34.16 34.16-34.17 34.16-82.97t-34.16-82.97Q720.8-597.13 672-597.13h-98.91q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q83.05 0 141.59 58.6 58.54 58.6 58.54 141.74 0 83.14-58.54 141.53T672-279.87h-98.91Z"/></svg>
</a> <a class='source' target='_blank' rel='nofollow' href='https://github.com/flix/flix/blob/master/main/src/library/BPlusTree%5CLock.flix#L78-L85#L78-L85'>Source</a></span></div><div class='doc'><p>Unlock <code>lock</code> with the issued write-stamp, <code>stamp</code>.</p>
<p>This operation is non-blocking.</p>
</div></div><div class='box' id='def-valid'><div class='decl'><code><span class='keyword'>def</span> <span class='name'>valid</span><span class='fparams'>(<span><span>stamp</span>: <span class='type'>Int64</span></span>, <span><span>lock</span>: <span class='type'>Lock[r]</span></span>)</span>: <span class='type'>Bool</span> \ <span class='effect'>r</span></code><span class='actions'><a href='#def-valid' class='copy-link' title='Link To Element'><!-- Google Material Symbols - "Link" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Link Icon"><path d="M288-279.87q-83.05 0-141.59-58.6-58.54-58.6-58.54-141.74 0-83.14 58.54-141.53T288-680.13h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288q-48.8 0-82.97 34.16-34.16 34.17-34.16 82.97t34.16 82.97q34.17 34.16 82.97 34.16h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288Zm80.7-162.22q-16.1 0-27.15-10.84-11.05-10.84-11.05-26.86t10.89-27.07q10.89-11.05 26.98-11.05H591.3q16.1 0 27.15 10.84 11.05 10.84 11.05 26.86t-10.89 27.07q-10.89 11.05-26.98 11.05H368.7Zm204.39 162.22q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q48.8 0 82.97-34.16 34.16-34.17 34.16-82.97t-34.16-82.97Q720.8-597.13 672-597.13h-98.91q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q83.05 0 141.59 58.6 58.54 58.6 58.54 141.74 0 83.14-58.54 141.53T672-279.87h-98.91Z"/></svg>
</a> <a class='source' target='_blank' rel='nofollow' href='https://github.com/flix/flix/blob/master/main/src/library/BPlusTree%5CLock.flix#L87-L95#L87-L95'>Source</a></span></div><div class='doc'><p>Returns true if <code>stamp</code> is still valid on <code>lock</code>, meaning no thread
has acquired a write-lock on <code>lock</code> since <code>stamp</code> was issued.</p>
<p>This operation is non-blocking.</p>
</div></div><div class='box' id='def-writeLock'><div class='decl'><code><span class='keyword'>def</span> <span class='name'>writeLock</span><span class='fparams'>(<span><span>lock</span>: <span class='type'>Lock[r]</span></span>)</span>: <span class='type'>Int64</span> \ <span class='effect'>r</span></code><span class='actions'><a href='#def-writeLock' class='copy-link' title='Link To Element'><!-- Google Material Symbols - "Link" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Link Icon"><path d="M288-279.87q-83.05 0-141.59-58.6-58.54-58.6-58.54-141.74 0-83.14 58.54-141.53T288-680.13h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288q-48.8 0-82.97 34.16-34.16 34.17-34.16 82.97t34.16 82.97q34.17 34.16 82.97 34.16h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288Zm80.7-162.22q-16.1 0-27.15-10.84-11.05-10.84-11.05-26.86t10.89-27.07q10.89-11.05 26.98-11.05H591.3q16.1 0 27.15 10.84 11.05 10.84 11.05 26.86t-10.89 27.07q-10.89 11.05-26.98 11.05H368.7Zm204.39 162.22q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q48.8 0 82.97-34.16 34.16-34.17 34.16-82.97t-34.16-82.97Q720.8-597.13 672-597.13h-98.91q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q83.05 0 141.59 58.6 58.54 58.6 58.54 141.74 0 83.14-58.54 141.53T672-279.87h-98.91Z"/></svg>
</a> <a class='source' target='_blank' rel='nofollow' href='https://github.com/flix/flix/blob/master/main/src/library/BPlusTree%5CLock.flix#L97-L104#L97-L104'>Source</a></span></div><div class='doc'><p>Lock <code>lock</code> and returns the stamp.</p>
<p>This operation is blocking.</p>
</div></div><div class='box' id='def-yieldBasedOn'><div class='decl'><code><span class='keyword'>def</span> <span class='name'>yieldBasedOn</span><span class='fparams'>(<span><span>lock</span>: <span class='type'>Lock[r]</span></span>)</span>: <span class='type'>Unit</span> \ <span class='effect'>r</span></code><span class='actions'><a href='#def-yieldBasedOn' class='copy-link' title='Link To Element'><!-- Google Material Symbols - "Link" -->
<!-- Rounded, Weight: 500, Grade: 0, Optical size: 20px -->
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor" aria-label="Link Icon"><path d="M288-279.87q-83.05 0-141.59-58.6-58.54-58.6-58.54-141.74 0-83.14 58.54-141.53T288-680.13h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288q-48.8 0-82.97 34.16-34.16 34.17-34.16 82.97t34.16 82.97q34.17 34.16 82.97 34.16h98.91q17.46 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.02 12.17-29.48 12.17H288Zm80.7-162.22q-16.1 0-27.15-10.84-11.05-10.84-11.05-26.86t10.89-27.07q10.89-11.05 26.98-11.05H591.3q16.1 0 27.15 10.84 11.05 10.84 11.05 26.86t-10.89 27.07q-10.89 11.05-26.98 11.05H368.7Zm204.39 162.22q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q48.8 0 82.97-34.16 34.16-34.17 34.16-82.97t-34.16-82.97Q720.8-597.13 672-597.13h-98.91q-17.46 0-29.48-11.96-12.02-11.97-12.02-29.33t12.02-29.54q12.02-12.17 29.48-12.17H672q83.05 0 141.59 58.6 58.54 58.6 58.54 141.74 0 83.14-58.54 141.53T672-279.87h-98.91Z"/></svg>
</a> <a class='source' target='_blank' rel='nofollow' href='https://github.com/flix/flix/blob/master/main/src/library/BPlusTree%5CLock.flix#L24-L42#L24-L42'>Source</a></span></div><div class='doc'><p>Wait for <code>lock</code> to be unlocked by the current holder of the write-lock on it.</p>
<p>Why:</p>
<p>Virtual threads can exhibit weird behaviour when using all physical threads
and using locking. Without this the threads using optimistic reading will
never be removed from the physical thread. Meanwhile a thread that holds the
lock will never get to run and we have a deadlock. Progress can happen, but it
appears to be extremely unlikely. To fix this call a blocking operation which
makes the JVM remove the virtual threads from the physical threads allowing
the lock-holder to unlock.</p>
<p>For a better explanation see Netflix's encounter of a similar problem:
https://netflixtechblog.com/java-21-virtual-threads-dude-wheres-my-lock-3052540e231d?gi=128dba0ad426</p>
</div></div></section></main></body>